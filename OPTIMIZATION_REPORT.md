# üî• –û—Ç—á—ë—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ API –∑–∞–ø—Ä–æ—Å–æ–≤ KiraKira

## –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∞ **"Quota exceeded: max number of jobs that can be queued per project"** –≤ BigQuery/Supabase.

## –ü—Ä–∏—á–∏–Ω–∞
–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API –∏–∑-–∑–∞:
1. ‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (`refetchInterval`)
2. ‚ùå –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–æ–∑–≤—Ä–∞—Ç–µ —Ñ–æ–∫—É—Å–∞ (`refetchOnWindowFocus: true`)
3. ‚ùå –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ invalidateQueries –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –º—É—Ç–∞—Ü–∏–∏
4. ‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ `staleTime` (30 —Å–µ–∫—É–Ω–¥ - 5 –º–∏–Ω—É—Ç)
5. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞ –¥–ª—è —á–∞—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### ‚úÖ 1. –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

**–§–∞–π–ª:** `src/hooks/queries/useChallengeQueries.ts`

**–ë—ã–ª–æ:**
```typescript
refetchInterval: 1000 * 60, // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É!
```

**–°—Ç–∞–ª–æ:**
```typescript
// ‚ùå –£–î–ê–õ–ï–ù–û: –í—ã–∑—ã–≤–∞–ª–æ quota exceeded
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
```

### ‚úÖ 2. –û—Ç–∫–ª—é—á–µ–Ω refetchOnWindowFocus

**–§–∞–π–ª—ã:**
- `src/main.tsx` (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
- `src/hooks/queries/useChallengeQueries.ts`
- `src/hooks/queries/useUserQueries.ts`
- `src/hooks/queries/useGardenQueries.ts`
- `src/hooks/queries/useMoodQueries.ts`
- `src/hooks/queries/useDailyQuestQueries.ts`

**–ë—ã–ª–æ:**
```typescript
refetchOnWindowFocus: true,
```

**–°—Ç–∞–ª–æ:**
```typescript
refetchOnWindowFocus: false, // ‚ùå –û–¢–ö–õ–Æ–ß–ï–ù–û
```

### ‚úÖ 3. –£–≤–µ–ª–∏—á–µ–Ω staleTime

| –•—É–∫ | –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|-----|------|-------|
| `useChallengeDetails` | 30 —Å–µ–∫ | 3 –º–∏–Ω |
| `useChallengeList` | 1 –º–∏–Ω | 3 –º–∏–Ω |
| `useUserSync` | 5 –º–∏–Ω | 10 –º–∏–Ω |
| `useGardenSync` | 30 —Å–µ–∫ | 5 –º–∏–Ω |
| `useMoodSync` | 30 —Å–µ–∫ | 5 –º–∏–Ω |
| `useDailyQuests` | 5 –º–∏–Ω | 10 –º–∏–Ω |
| –ì–ª–æ–±–∞–ª—å–Ω–æ (main.tsx) | 5 –º–∏–Ω | 10 –º–∏–Ω |

### ‚úÖ 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã invalidateQueries

**–ë—ã–ª–æ:**
```typescript
// 10+ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö invalidateQueries –≤—ã–∑–æ–≤–æ–≤
queryClient.invalidateQueries({ queryKey: ... })
queryClient.invalidateQueries({ queryKey: ... })
queryClient.invalidateQueries({ queryKey: ... })
// ...
```

**–°—Ç–∞–ª–æ:**
```typescript
// –ë–∞—Ç—á–∏–Ω–≥ –≤ Promise.all + refetchType: 'active'
void Promise.all([
  queryClient.invalidateQueries({
    predicate: (query) => { /* —É–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è */ },
    refetchType: 'active', // —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ queries
  }),
  // ...
])
```

### ‚úÖ 5. –î–æ–±–∞–≤–ª–µ–Ω –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `src/utils/debounce.ts`

–°–æ–¥–µ—Ä–∂–∏—Ç —É—Ç–∏–ª–∏—Ç—ã:
- `debounce()` - –∑–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- `throttle()` - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã
- `createBatcher()` - –±–∞—Ç—á–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –≤:** `src/hooks/useStoresSync.ts`

```typescript
const debouncedSyncRef = useRef(
  debounce(async (telegramId: number) => {
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 2 —Å–µ–∫—É–Ω–¥—ã
  }, 2000)
)
```

### ‚úÖ 6. –°–Ω–∏–∂–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (retry)

**–§–∞–π–ª:** `src/main.tsx`

**–ë—ã–ª–æ:**
```typescript
retry: 2,
```

**–°—Ç–∞–ª–æ:**
```typescript
retry: 1, // –ë—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
```

## –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- üìä –ó–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É: **~100-500** (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
- üî• –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫: **~20-50 –∑–∞–ø—Ä–æ—Å–æ–≤**
- ‚è±Ô∏è –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π: **1 –∑–∞–ø—Ä–æ—Å/–º–∏–Ω—É—Ç—É √ó N —á–µ–ª–ª–µ–Ω–¥–∂–µ–π**
- üí• –ü–æ—Å–ª–µ –º—É—Ç–∞—Ü–∏–π: **~10-15 –∑–∞–ø—Ä–æ—Å–æ–≤** (invalidate)

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- üìä –ó–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É: **~10-30** (—Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 70-90%)
- üî• –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫: **0 –∑–∞–ø—Ä–æ—Å–æ–≤** 
- ‚è±Ô∏è –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: **–û–¢–ö–õ–Æ–ß–ï–ù–û**
- üí• –ü–æ—Å–ª–µ –º—É—Ç–∞—Ü–∏–π: **~5-7 –∑–∞–ø—Ä–æ—Å–æ–≤** (–±–∞—Ç—á–∏–Ω–≥)

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤
–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ React Query –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
```typescript
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'

// –í App.tsx
<ReactQueryDevtools initialIsOpen={false} />
```

### 2. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–æ–≤—ã–µ —Ö—É–∫–∏ –Ω–∞:
- ‚ùå `refetchInterval` - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- ‚ùå `refetchOnWindowFocus: true` - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ `staleTime` >= 3 –º–∏–Ω—É—Ç—ã –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `refetchType: 'active'` –≤ invalidateQueries

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞
–î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è —á–∞—Å—Ç–æ:
```typescript
import { debounce } from '@/utils/debounce'

const debouncedFunction = debounce(yourFunction, 2000)
```

### 4. –ë–∞—Ç—á–∏–Ω–≥ API –∑–∞–ø—Ä–æ—Å–æ–≤
–î–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `createBatcher`:
```typescript
import { createBatcher } from '@/utils/debounce'

const batcher = createBatcher({
  batchWindow: 100,
  maxBatchSize: 10,
  execute: async (items) => {
    // –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö items
  }
})
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ Supabase –∫–≤–æ—Ç
–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–≤–æ—Ç:
- Dashboard ‚Üí Settings ‚Üí Usage
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 80% –∫–≤–æ—Ç—ã

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - –∫–∞–∫–∏–µ API endpoints –≤—ã–∑—ã–≤–∞—é—Ç—Å—è —á–∞—â–µ –≤—Å–µ–≥–æ
2. ‚úÖ –í—Ä–µ–º–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á—å—Ç–µ `staleTime` –¥–æ 15-20 –º–∏–Ω—É—Ç
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–∏ `refetchInterval` –≤ –Ω–æ–≤—ã—Ö —Ö—É–∫–∞—Ö

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:
1. ‚úÖ –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Supabase Pro plan (–±–æ–ª—å—à–µ –∫–≤–æ—Ç)
2. ‚úÖ –†–µ–∞–ª–∏–∑—É–π—Ç–µ server-side –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis/Upstash)
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ polling
4. ‚úÖ –î–æ–±–∞–≤—å—Ç–µ rate limiting –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

## –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

–ü–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ React Query —Ö—É–∫–∞:
- [ ] `staleTime` >= 3 –º–∏–Ω—É—Ç—ã?
- [ ] `refetchOnWindowFocus` = false –∏–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ?
- [ ] –ù–µ—Ç `refetchInterval`?
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `refetchType: 'active'` –≤ invalidateQueries?
- [ ] –î–æ–±–∞–≤–ª–µ–Ω –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥ –¥–ª—è —á–∞—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π?
- [ ] `retry` <= 2?

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–º–æ—â–∏

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ React Query DevTools –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Supabase Usage Dashboard
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

---

**–î–∞—Ç–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** 24.11.2025  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

