<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /

  # РЕДИРЕКТ С WWW НА БЕЗ-WWW
  RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
  RewriteRule ^(.*)$ https://%1/$1 [R=301,L]
  
  # Если запрос идет к существующему файлу или папке - отдаем их как есть
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  
  # ВАЖНО: Если запрос идет к /api, не перенаправляем его на index.html!
  # Пусть с ним разбирается ваш прокси в папке api
  RewriteCond %{REQUEST_URI} !^/api/

  # Все остальные запросы перенаправляем на index.html
  RewriteRule . /index.html [L]
</IfModule>

# Cache-Control для SPA/PWA (важно при деплоях с хешированными чанками)
<IfModule mod_headers.c>
  # entrypoint HTML нельзя кэшировать, иначе он будет ссылаться на старые page-*.js
  <Files "index.html">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header set Pragma "no-cache"
  </Files>

  # Service Worker и манифест должны быстро обновляться
  <FilesMatch "^(sw\.js|registerSW\.js|workbox-.*\.js|manifest\.webmanifest|manifest\.json)$">
    Header set Cache-Control "no-cache"
  </FilesMatch>

  # Хешированные ассеты Vite безопасно кэшировать надолго
  <IfModule mod_setenvif.c>
    SetEnvIf Request_URI "^/assets/" IS_VITE_ASSET=1
    Header set Cache-Control "public, max-age=31536000, immutable" env=IS_VITE_ASSET
  </IfModule>
</IfModule>